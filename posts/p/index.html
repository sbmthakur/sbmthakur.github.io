<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="${description}">
    <title>Consuming Podman events</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>

    <header>
      <h1 class="home"><a href="/"></a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

        <h1>Consuming Podman events</h1>



<p>Recently I had a use-case where I had to trigger a certain action after a specific sequence of events. I had no idea how long the sequence will take. I thought of scheduling this action on a separate thread after sometime. However, after a few tests it became clear that this approach is not fault tolerant. To my luck, this entire sequence ran in a container which is stopped once the sequence ends. It became clear that <a href="https://github.com/containers/podman/blob/main/docs/source/markdown/podman-events.1.md">Podman events</a> can come handy here.</p>
<p>For my use-case, I am only interested in the <code>stop</code> events. This can be easily done by passing a <em>filter</em> to the <code>podman events</code> command.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">podman</span> events --filter<span class="token operator">=</span><span class="token string">"event=stop"</span><br><span class="token number">2022</span>-06-19 <span class="token number">16</span>:28:04.905386281 -0500 CDT container stop af9066a8e482dcfac4a4a3528f54a10610d0bf03613a720c494c8ec5b21eca91 <span class="token punctuation">(</span>image<span class="token operator">=</span>docker.io/library/python:latest, <span class="token assign-left variable">name</span><span class="token operator">=</span>focused_proskuriakova<span class="token punctuation">)</span></code></pre>
<p>These events are also exposed through <a href="https://docs.podman.io/en/v3.2.3/_static/api.html">Podman v2.0 RESTful API</a>. The folks who manage Podman have provided <a href="https://github.com/containers/podman-py">Python bindings</a> to use this API. Before using the library we need to enable the Podman socket which allows us to use the API[1].</p>
<pre class="language-bash"><code class="language-bash">$ systemctl <span class="token builtin class-name">enable</span> --now podman.socket</code></pre>
<p>Once enabled, we can connect to the Podman's socket and start looking for events. Note the <code>filters</code> parameter to <code>client.events</code> function. This is the same filter that we had passed to the <code>podman events</code> command in the previous section.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os<br><span class="token keyword">from</span> podman <span class="token keyword">import</span> PodmanClient<br><br>uid <span class="token operator">=</span> os<span class="token punctuation">.</span>getuid<span class="token punctuation">(</span><span class="token punctuation">)</span><br>uri <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"unix:///run/user/</span><span class="token interpolation"><span class="token punctuation">{</span>uid<span class="token punctuation">}</span></span><span class="token string">/podman/podman.sock"</span></span><br><br><span class="token keyword">with</span> PodmanClient<span class="token punctuation">(</span>base_url<span class="token operator">=</span>uri<span class="token punctuation">)</span> <span class="token keyword">as</span> client<span class="token punctuation">:</span><br>    event_generator <span class="token operator">=</span> client<span class="token punctuation">.</span>events<span class="token punctuation">(</span><br>        decode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <br>        filters<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token string">'event'</span><span class="token punctuation">:</span> <span class="token string">'stop'</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">)</span><br><br>    <span class="token keyword">for</span> e <span class="token keyword">in</span> event_generator<span class="token punctuation">:</span><br>        container_name <span class="token operator">=</span> e<span class="token punctuation">[</span><span class="token string">'Actor'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Attributes'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><br>        <span class="token keyword">print</span><span class="token punctuation">(</span>container_name<span class="token punctuation">)</span></code></pre>
<p>We can name the script as <code>events.py</code>. To test it out, we can run a couple of containers in <em>detached</em> mode and <strong>stop</strong> them with podman. The script will print the container names if it's running correctly.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">podman</span> run --name http_server -d docker.io/httpd<br>$ <span class="token function">podman</span> run --name my_redis -d docker.io/redis</code></pre>
<p>We can start looking for the events by running <code>events.py</code>:</p>
<pre class="language-bash"><code class="language-bash">$ python events.py<br>  </code></pre>
<p>We can issue the stop commands in another terminal:</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">podman</span> stop http_server my_redis</code></pre>
<p>Check output of <code>events.py</code> and we should see the same container names over there.</p>
<pre class="language-bash"><code class="language-bash">$ python events.py <br>http_server<br>my_redis</code></pre>
<h3>References:</h3>
<ol>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/assembly_using-the-container-tools-api_building-running-and-managing-containers">Using the container-tools API</a></li>
</ol>

<hr>
<ul><li>Next: <a href="/posts/q/">second post</a></li>
</ul>

    </main>
        <footer></footer>
  </body>
</html>